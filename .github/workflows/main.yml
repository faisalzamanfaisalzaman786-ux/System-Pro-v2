name: Build Real APK from Dispatch

on:
  repository_dispatch:
    types: [build-apk]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Decode and prepare logo (with fallback)
        run: |
          set -x
          echo "Base64 length: ${#LOGO_BASE64}"
          
          if [ -z "$LOGO_BASE64" ]; then
            echo "⚠️ Logo base64 is empty, using default icon from template"
            # Default icon already exists in android-template, just copy it to all densities
            mkdir -p android-template/app/src/main/res/mipmap-mdpi
            mkdir -p android-template/app/src/main/res/mipmap-hdpi
            mkdir -p android-template/app/src/main/res/mipmap-xhdpi
            mkdir -p android-template/app/src/main/res/mipmap-xxhdpi
            mkdir -p android-template/app/src/main/res/mipmap-xxxhdpi
            cp android-template/app/src/main/res/mipmap-hdpi/ic_launcher.png android-template/app/src/main/res/mipmap-mdpi/ic_launcher.png 2>/dev/null || true
            cp android-template/app/src/main/res/mipmap-hdpi/ic_launcher.png android-template/app/src/main/res/mipmap-hdpi/ic_launcher.png 2>/dev/null || true
            cp android-template/app/src/main/res/mipmap-hdpi/ic_launcher.png android-template/app/src/main/res/mipmap-xhdpi/ic_launcher.png 2>/dev/null || true
            cp android-template/app/src/main/res/mipmap-hdpi/ic_launcher.png android-template/app/src/main/res/mipmap-xxhdpi/ic_launcher.png 2>/dev/null || true
            cp android-template/app/src/main/res/mipmap-hdpi/ic_launcher.png android-template/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png 2>/dev/null || true
            echo "✅ Default icons used"
            exit 0
          fi
          
          echo "First 100 chars: ${LOGO_BASE64:0:100}"
          
          # Base64 decode
          echo "$LOGO_BASE64" | base64 --decode > original_logo.png || { echo "❌ base64 decode failed"; exit 1; }
          
          # Check file size
          echo "File size: $(wc -c < original_logo.png) bytes"
          
          # Install ImageMagick
          sudo apt-get update && sudo apt-get install -y imagemagick
          
          # Validate image
          identify original_logo.png || { echo "❌ Not a valid image"; exit 1; }
          
          # Create target directories
          mkdir -p android-template/app/src/main/res/mipmap-mdpi
          mkdir -p android-template/app/src/main/res/mipmap-hdpi
          mkdir -p android-template/app/src/main/res/mipmap-xhdpi
          mkdir -p android-template/app/src/main/res/mipmap-xxhdpi
          mkdir -p android-template/app/src/main/res/mipmap-xxxhdpi
          
          # Resize icons
          convert original_logo.png -resize 48x48! android-template/app/src/main/res/mipmap-mdpi/ic_launcher.png
          convert original_logo.png -resize 72x72! android-template/app/src/main/res/mipmap-hdpi/ic_launcher.png
          convert original_logo.png -resize 96x96! android-template/app/src/main/res/mipmap-xhdpi/ic_launcher.png
          convert original_logo.png -resize 144x144! android-template/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          convert original_logo.png -resize 192x192! android-template/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          
          echo "✅ Logo successfully processed"
        env:
          LOGO_BASE64: ${{ github.event.client_payload.logoBase64 }}

      - name: List android-template contents
        run: |
          ls -la android-template || echo "android-template folder not found!"
          ls -la android-template/app/src/main/AndroidManifest.xml || echo "AndroidManifest.xml missing!"

      - name: Generate unique package name
        id: package
        run: |
          APP_NAME_SLUG=$(echo "${{ github.event.client_payload.appName }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]//g')
          TIMESTAMP=$(date +%s)
          PACKAGE_NAME="com.userbuild.${APP_NAME_SLUG}.${TIMESTAMP}"
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "✅ Package name: $PACKAGE_NAME"

      - name: Inject package name and app name
        run: |
          if [ ! -f android-template/app/src/main/AndroidManifest.xml ]; then
            echo "❌ AndroidManifest.xml not found! Ensure android-template is in root."
            exit 1
          fi
          
          sed -i "s/package=\"com\.placeholder\"/package=\"${{ steps.package.outputs.package_name }}\"/g" android-template/app/src/main/AndroidManifest.xml
          sed -i "s/applicationId \"com\.placeholder\"/applicationId \"${{ steps.package.outputs.package_name }}\"/g" android-template/app/build.gradle
          sed -i "s/package com\.placeholder/package ${{ steps.package.outputs.package_name }}/g" android-template/app/src/main/java/com/placeholder/MainActivity.kt
          sed -i "s/<string name=\"app_name\">.*<\/string>/<string name=\"app_name\">${{ github.event.client_payload.appName }}<\/string>/g" android-template/app/src/main/res/values/strings.xml
          sed -i "s|webView.loadUrl(\".*\")|webView.loadUrl(\"${{ github.event.client_payload.appUrl }}\")|g" android-template/app/src/main/java/com/placeholder/MainActivity.kt
          echo "✅ Package name and app details injected"

      - name: Build APK with Gradle
        run: |
          cd android-template
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-apk
          path: android-template/app/build/outputs/apk/debug/app-debug.apk

      - name: Create Release and Upload APK
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v3.0-${{ steps.package.outputs.package_name }}
          name: "APK Build ${{ github.event.client_payload.appName }}"
          files: android-template/app/build/outputs/apk/debug/app-debug.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
