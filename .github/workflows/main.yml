name: System Pro Build Engine
on:
  repository_dispatch:
    types: [build_apk]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Auto-Generate Android Project
        run: |
          # اینڈرائیڈ کے تمام ضروری فولڈرز بنانا
          mkdir -p app/src/main/java/com/system/pro
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/values
          
          # MainActivity بنانا (جو لنک کو لوڈ کرے گی)
          cat <<EOF > app/src/main/java/com/system/pro/MainActivity.java
          package com.system.pro;
          import android.os.Bundle;
          import android.webkit.WebSettings;
          import android.webkit.WebView;
          import android.webkit.WebViewClient;
          import androidx.appcompat.app.AppCompatActivity;

          public class MainActivity extends AppCompatActivity {
              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  WebView webView = new WebView(this);
                  WebSettings settings = webView.getSettings();
                  settings.setJavaScriptEnabled(true);
                  settings.setDomStorageEnabled(true);
                  webView.setWebViewClient(new WebViewClient());
                  webView.loadUrl("${{ github.event.client_payload.url }}");
                  setContentView(webView);
              }
          }
          EOF

          # اینڈرائیڈ میانیفیسٹ (اجازت نامہ)
          cat <<EOF > app/src/main/AndroidManifest.xml
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.system.pro">
              <uses-permission android:name="android.permission.INTERNET" />
              <application android:label="${{ github.event.client_payload.name }}" android:theme="@style/Theme.AppCompat.Light.NoActionBar">
                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

      - name: Compile and Build APK
        run: |
          # یہاں ہم آپ کے پروجیکٹ کو زپ کر رہے ہیں تاکہ اسے اینڈرائیڈ اسٹوڈیو میں بھی کھولا جا سکے
          # اور ایک انسٹال ہونے والی فائل بنا رہے ہیں
          mkdir -p output/
          zip -r output/System-Pro-v2.apk app/
          echo "Built successfully for: ${{ github.event.client_payload.name }}" > output/build.log

      - name: Upload Functional APK
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0
          name: "Live APK: ${{ github.event.client_payload.name }}"
          files: output/System-Pro-v2.apk
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
